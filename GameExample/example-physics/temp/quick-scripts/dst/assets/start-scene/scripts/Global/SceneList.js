
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/start-scene/scripts/Global/SceneList.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, '473b8wxs55OsJvoxVdYCzTF', 'SceneList');
// start-scene/scripts/Global/SceneList.js

"use strict";

cc.Class({
  "extends": cc.Component,
  properties: {
    itemPrefab: {
      "default": null,
      type: cc.Prefab
    },
    initItemCount: 0,
    scrollView: cc.ScrollView,
    bufferZone: 0 // when item is away from bufferZone, we relocate it

  },
  createItem: function createItem(x, y, name, url) {
    var item = cc.instantiate(this.itemPrefab);
    var itemComp = item.getComponent('ListItem');
    var label = itemComp.label;
    label.string = name;

    if (url) {
      itemComp.url = url;
    } // item.width = w;


    item.x = x;
    item.y = y;
    this.node.addChild(item);
    return item;
  },
  init: function init(menu) {
    this.menu = menu;
    this.sceneList = [];
    this.itemList = [];
    this.updateTimer = 0;
    this.updateInterval = 0.2;
    this.lastContentPosY = 0; // use this variable to detect if we are scrolling up or down

    this.initList();
  },
  // use this for initialization
  initList: function initList() {
    var scenes = cc.game._sceneInfos;
    var dict = {};

    if (scenes) {
      var i, j;

      for (i = 0; i < scenes.length; ++i) {
        var url = scenes[i].url;
        var dirname = cc.path.dirname(url).replace('db://assets/cases/', '');

        if (dirname === 'db://assets/resources/test assets') {
          continue;
        }

        var scenename = cc.path.basename(url, '.fire');
        if (scenename === 'TestList') continue;
        if (!dirname) dirname = '_root';

        if (!dict[dirname]) {
          dict[dirname] = {};
        }

        dict[dirname][scenename] = url;
      }
    } else {
      cc.log('failed to get scene list!');
    } // compile scene dict to an array


    var dirs = Object.keys(dict);
    dirs.sort();

    for (var _i = 0; _i < dirs.length; ++_i) {
      this.sceneList.push({
        name: dirs[_i],
        url: null
      });
      var scenenames = Object.keys(dict[dirs[_i]]);
      scenenames.sort();

      for (var _j = 0; _j < scenenames.length; ++_j) {
        var name = scenenames[_j];
        this.sceneList.push({
          name: name,
          url: dict[dirs[_i]][name]
        });
      }
    }

    var y = 0;
    this.node.height = (this.sceneList.length + 1) * 50;

    for (var _i2 = 0; _i2 < this.initItemCount; ++_i2) {
      var item = cc.instantiate(this.itemPrefab).getComponent('ListItem');
      var itemInfo = this.sceneList[_i2];
      item.init(this.menu);
      this.node.addChild(item.node);
      y -= 50;
      item.updateItem(_i2, y, itemInfo.name, itemInfo.url);
      this.itemList.push(item);
    }
  },
  getPositionInView: function getPositionInView(item) {
    // get item position in scrollview's node space
    var worldPos = item.parent.convertToWorldSpaceAR(item.position);
    var viewPos = this.scrollView.node.convertToNodeSpaceAR(worldPos);
    return viewPos;
  },
  update: function update(dt) {
    this.updateTimer += dt;

    if (this.updateTimer < this.updateInterval) {
      return; // we don't need to do the math every frame
    }

    this.updateTimer = 0;
    var items = this.itemList;
    var buffer = this.bufferZone;
    var isDown = this.node.y < this.lastContentPosY; // scrolling direction

    var curItemCount = this.itemList.length;
    var offset = 50 * curItemCount;

    for (var i = 0; i < curItemCount; ++i) {
      var item = items[i];
      var itemNode = item.node;
      var viewPos = this.getPositionInView(itemNode);

      if (isDown) {
        // if away from buffer zone and not reaching top of content
        if (viewPos.y < -buffer && itemNode.y + offset < 0) {
          var newIdx = item.index - curItemCount;
          var newInfo = this.sceneList[newIdx];
          item.updateItem(newIdx, itemNode.y + offset, newInfo.name, newInfo.url);
        }
      } else {
        // if away from buffer zone and not reaching bottom of content
        if (viewPos.y > buffer && itemNode.y - offset > -this.node.height) {
          var _newIdx = item.index + curItemCount;

          var _newInfo = this.sceneList[_newIdx];
          item.updateItem(_newIdx, itemNode.y - offset, _newInfo.name, _newInfo.url);
        }
      }
    } // update lastContentPosY


    this.lastContentPosY = this.node.y;
  }
});

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0cy9zdGFydC1zY2VuZS9zY3JpcHRzL0dsb2JhbC9TY2VuZUxpc3QuanMiXSwibmFtZXMiOlsiY2MiLCJDbGFzcyIsIkNvbXBvbmVudCIsInByb3BlcnRpZXMiLCJpdGVtUHJlZmFiIiwidHlwZSIsIlByZWZhYiIsImluaXRJdGVtQ291bnQiLCJzY3JvbGxWaWV3IiwiU2Nyb2xsVmlldyIsImJ1ZmZlclpvbmUiLCJjcmVhdGVJdGVtIiwieCIsInkiLCJuYW1lIiwidXJsIiwiaXRlbSIsImluc3RhbnRpYXRlIiwiaXRlbUNvbXAiLCJnZXRDb21wb25lbnQiLCJsYWJlbCIsInN0cmluZyIsIm5vZGUiLCJhZGRDaGlsZCIsImluaXQiLCJtZW51Iiwic2NlbmVMaXN0IiwiaXRlbUxpc3QiLCJ1cGRhdGVUaW1lciIsInVwZGF0ZUludGVydmFsIiwibGFzdENvbnRlbnRQb3NZIiwiaW5pdExpc3QiLCJzY2VuZXMiLCJnYW1lIiwiX3NjZW5lSW5mb3MiLCJkaWN0IiwiaSIsImoiLCJsZW5ndGgiLCJkaXJuYW1lIiwicGF0aCIsInJlcGxhY2UiLCJzY2VuZW5hbWUiLCJiYXNlbmFtZSIsImxvZyIsImRpcnMiLCJPYmplY3QiLCJrZXlzIiwic29ydCIsInB1c2giLCJzY2VuZW5hbWVzIiwiaGVpZ2h0IiwiaXRlbUluZm8iLCJ1cGRhdGVJdGVtIiwiZ2V0UG9zaXRpb25JblZpZXciLCJ3b3JsZFBvcyIsInBhcmVudCIsImNvbnZlcnRUb1dvcmxkU3BhY2VBUiIsInBvc2l0aW9uIiwidmlld1BvcyIsImNvbnZlcnRUb05vZGVTcGFjZUFSIiwidXBkYXRlIiwiZHQiLCJpdGVtcyIsImJ1ZmZlciIsImlzRG93biIsImN1ckl0ZW1Db3VudCIsIm9mZnNldCIsIml0ZW1Ob2RlIiwibmV3SWR4IiwiaW5kZXgiLCJuZXdJbmZvIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBQSxFQUFFLENBQUNDLEtBQUgsQ0FBUztFQUNMLFdBQVNELEVBQUUsQ0FBQ0Us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Q0FBQ3ZELENBQVQsR0FBYXNELE1BQXJDLEVBQTZDSSxRQUFPLENBQUN6RCxJQUFyRCxFQUEyRHlELFFBQU8sQ0FBQ3hELEdBQW5FO1FBQ0g7TUFDSjtJQUNKLENBOUJPLENBK0JSOzs7SUFDQSxLQUFLZSxlQUFMLEdBQXVCLEtBQUtSLElBQUwsQ0FBVVQsQ0FBakM7RUFDSDtBQXhJSSxDQUFUIiwic291cmNlUm9vdCI6Ii8iLCJzb3VyY2VzQ29udGVudCI6WyJjYy5DbGFzcyh7XG4gICAgZXh0ZW5kczogY2MuQ29tcG9uZW50LFxuXG4gICAgcHJvcGVydGllczoge1xuICAgICAgICBpdGVtUHJlZmFiOiB7XG4gICAgICAgICAgICBkZWZhdWx0OiBudWxsLFxuICAgICAgICAgICAgdHlwZTogY2MuUHJlZmFiXG4gICAgICAgIH0sXG4gICAgICAgIGluaXRJdGVtQ291bnQ6IDAsXG4gICAgICAgIHNjcm9sbFZpZXc6IGNjLlNjcm9sbFZpZXcsXG4gICAgICAgIGJ1ZmZlclpvbmU6IDAsIC8vIHdoZW4gaXRlbSBpcyBhd2F5IGZyb20gYnVmZmVyWm9uZSwgd2UgcmVsb2NhdGUgaXRcbiAgICB9LFxuXG4gICAgY3JlYXRlSXRlbTogZnVuY3Rpb24gKHgsIHksIG5hbWUsIHVybCkge1xuICAgICAgICB2YXIgaXRlbSA9IGNjLmluc3RhbnRpYXRlKHRoaXMuaXRlbVByZWZhYik7XG4gICAgICAgIHZhciBpdGVtQ29tcCA9IGl0ZW0uZ2V0Q29tcG9uZW50KCdMaXN0SXRlbScpO1xuICAgICAgICB2YXIgbGFiZWwgPSBpdGVtQ29tcC5sYWJlbDtcbiAgICAgICAgbGFiZWwuc3RyaW5nID0gbmFtZTtcblxuICAgICAgICBpZiAodXJsKSB7XG4gICAgICAgICAgICBpdGVtQ29tcC51cmwgPSB1cmw7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBpdGVtLndpZHRoID0gdztcbiAgICAgICAgaXRlbS54ID0geDtcbiAgICAgICAgaXRlbS55ID0geTtcbiAgICAgICAgdGhpcy5ub2RlLmFkZENoaWxkKGl0ZW0pO1xuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICB9LFxuXG4gICAgaW5pdCAobWVudSkge1xuICAgICAgICB0aGlzLm1lbnUgPSBtZW51O1xuICAgICAgICB0aGlzLnNjZW5lTGlzdCA9IFtdO1xuICAgICAgICB0aGlzLml0ZW1MaXN0ID0gW107XG4gICAgICAgIHRoaXMudXBkYXRlVGltZXIgPSAwO1xuICAgICAgICB0aGlzLnVwZGF0ZUludGVydmFsID0gMC4yO1xuICAgICAgICB0aGlzLmxhc3RDb250ZW50UG9zWSA9IDA7IC8vIHVzZSB0aGlzIHZhcmlhYmxlIHRvIGRldGVjdCBpZiB3ZSBhcmUgc2Nyb2xsaW5nIHVwIG9yIGRvd25cbiAgICAgICAgdGhpcy5pbml0TGlzdCgpO1xuICAgIH0sXG5cbiAgICAvLyB1c2UgdGhpcyBmb3IgaW5pdGlhbGl6YXRpb25cbiAgICBpbml0TGlzdCAoKSB7XG4gICAgICAgIHZhciBzY2VuZXMgPSBjYy5nYW1lLl9zY2VuZUluZm9zO1xuICAgICAgICB2YXIgZGljdCA9IHt9O1xuXG4gICAgICAgIGlmIChzY2VuZXMpIHtcbiAgICAgICAgICAgIHZhciBpLCBqO1xuICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNjZW5lcy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgICAgIGxldCB1cmwgPSBzY2VuZXNbaV0udXJsO1xuICAgICAgICAgICAgICAgIGxldCBkaXJuYW1lID0gY2MucGF0aC5kaXJuYW1lKHVybCkucmVwbGFjZSgnZGI6Ly9hc3NldHMvY2FzZXMvJywgJycpO1xuICAgICAgICAgICAgICAgIGlmIChkaXJuYW1lID09PSAnZGI6Ly9hc3NldHMvcmVzb3VyY2VzL3Rlc3QgYXNzZXRzJykge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGV0IHNjZW5lbmFtZSA9IGNjLnBhdGguYmFzZW5hbWUodXJsLCAnLmZpcmUnKTtcbiAgICAgICAgICAgICAgICBpZiAoc2NlbmVuYW1lID09PSAnVGVzdExpc3QnKSBjb250aW51ZTtcblxuICAgICAgICAgICAgICAgIGlmICghZGlybmFtZSkgZGlybmFtZSA9ICdfcm9vdCc7XG4gICAgICAgICAgICAgICAgaWYgKCFkaWN0W2Rpcm5hbWVdKSB7XG4gICAgICAgICAgICAgICAgICAgIGRpY3RbZGlybmFtZV0gPSB7fTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZGljdFtkaXJuYW1lXVtzY2VuZW5hbWVdID0gdXJsO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjYy5sb2coJ2ZhaWxlZCB0byBnZXQgc2NlbmUgbGlzdCEnKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBjb21waWxlIHNjZW5lIGRpY3QgdG8gYW4gYXJyYXlcbiAgICAgICAgbGV0IGRpcnMgPSBPYmplY3Qua2V5cyhkaWN0KTtcbiAgICAgICAgZGlycy5zb3J0KCk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGlycy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgdGhpcy5zY2VuZUxpc3QucHVzaCh7XG4gICAgICAgICAgICAgICAgbmFtZTogZGlyc1tpXSxcbiAgICAgICAgICAgICAgICB1cmw6IG51bGxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgbGV0IHNjZW5lbmFtZXMgPSBPYmplY3Qua2V5cyhkaWN0W2RpcnNbaV1dKTtcbiAgICAgICAgICAgIHNjZW5lbmFtZXMuc29ydCgpO1xuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzY2VuZW5hbWVzLmxlbmd0aDsgKytqKSB7XG4gICAgICAgICAgICAgICAgbGV0IG5hbWUgPSBzY2VuZW5hbWVzW2pdO1xuICAgICAgICAgICAgICAgIHRoaXMuc2NlbmVMaXN0LnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgICAgICAgICB1cmw6IGRpY3RbZGlyc1tpXV1bbmFtZV1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsZXQgeSA9IDA7XG4gICAgICAgIHRoaXMubm9kZS5oZWlnaHQgPSAodGhpcy5zY2VuZUxpc3QubGVuZ3RoICsgMSkgKiA1MDtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmluaXRJdGVtQ291bnQ7ICsraSkge1xuICAgICAgICAgICAgbGV0IGl0ZW0gPSBjYy5pbnN0YW50aWF0ZSh0aGlzLml0ZW1QcmVmYWIpLmdldENvbXBvbmVudCgnTGlzdEl0ZW0nKTtcbiAgICAgICAgICAgIGxldCBpdGVtSW5mbyA9IHRoaXMuc2NlbmVMaXN0W2ldO1xuICAgICAgICAgICAgaXRlbS5pbml0KHRoaXMubWVudSk7XG4gICAgICAgICAgICB0aGlzLm5vZGUuYWRkQ2hpbGQoaXRlbS5ub2RlKTtcbiAgICAgICAgICAgIHkgLT0gNTA7XG4gICAgICAgICAgICBpdGVtLnVwZGF0ZUl0ZW0gKGksIHksIGl0ZW1JbmZvLm5hbWUsIGl0ZW1JbmZvLnVybCk7XG4gICAgICAgICAgICB0aGlzLml0ZW1MaXN0LnB1c2goaXRlbSk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgZ2V0UG9zaXRpb25JblZpZXc6IGZ1bmN0aW9uIChpdGVtKSB7IC8vIGdldCBpdGVtIHBvc2l0aW9uIGluIHNjcm9sbHZpZXcncyBub2RlIHNwYWNlXG4gICAgICAgIGxldCB3b3JsZFBvcyA9IGl0ZW0ucGFyZW50LmNvbnZlcnRUb1dvcmxkU3BhY2VBUihpdGVtLnBvc2l0aW9uKTtcbiAgICAgICAgbGV0IHZpZXdQb3MgPSB0aGlzLnNjcm9sbFZpZXcubm9kZS5jb252ZXJ0VG9Ob2RlU3BhY2VBUih3b3JsZFBvcyk7XG4gICAgICAgIHJldHVybiB2aWV3UG9zO1xuICAgIH0sXG5cbiAgICB1cGRhdGUgKGR0KSB7XG4gICAgICAgIHRoaXMudXBkYXRlVGltZXIgKz0gZHQ7XG4gICAgICAgIGlmICh0aGlzLnVwZGF0ZVRpbWVyIDwgdGhpcy51cGRhdGVJbnRlcnZhbCkge1xuICAgICAgICAgICAgcmV0dXJuOyAvLyB3ZSBkb24ndCBuZWVkIHRvIGRvIHRoZSBtYXRoIGV2ZXJ5IGZyYW1lXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy51cGRhdGVUaW1lciA9IDA7XG4gICAgICAgIGxldCBpdGVtcyA9IHRoaXMuaXRlbUxpc3Q7XG4gICAgICAgIGxldCBidWZmZXIgPSB0aGlzLmJ1ZmZlclpvbmU7XG4gICAgICAgIGxldCBpc0Rvd24gPSB0aGlzLm5vZGUueSA8IHRoaXMubGFzdENvbnRlbnRQb3NZOyAvLyBzY3JvbGxpbmcgZGlyZWN0aW9uXG4gICAgICAgIGxldCBjdXJJdGVtQ291bnQgPSB0aGlzLml0ZW1MaXN0Lmxlbmd0aDtcbiAgICAgICAgbGV0IG9mZnNldCA9IDUwICogY3VySXRlbUNvdW50O1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1ckl0ZW1Db3VudDsgKytpKSB7XG4gICAgICAgICAgICBsZXQgaXRlbSA9IGl0ZW1zW2ldO1xuICAgICAgICAgICAgbGV0IGl0ZW1Ob2RlID0gaXRlbS5ub2RlO1xuICAgICAgICAgICAgbGV0IHZpZXdQb3MgPSB0aGlzLmdldFBvc2l0aW9uSW5WaWV3KGl0ZW1Ob2RlKTtcbiAgICAgICAgICAgIGlmIChpc0Rvd24pIHtcbiAgICAgICAgICAgICAgICAvLyBpZiBhd2F5IGZyb20gYnVmZmVyIHpvbmUgYW5kIG5vdCByZWFjaGluZyB0b3Agb2YgY29udGVudFxuICAgICAgICAgICAgICAgIGlmICh2aWV3UG9zLnkgPCAtYnVmZmVyICYmIGl0ZW1Ob2RlLnkgKyBvZmZzZXQgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBuZXdJZHggPSBpdGVtLmluZGV4IC0gY3VySXRlbUNvdW50O1xuICAgICAgICAgICAgICAgICAgICBsZXQgbmV3SW5mbyA9IHRoaXMuc2NlbmVMaXN0W25ld0lkeF07XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0udXBkYXRlSXRlbShuZXdJZHgsIGl0ZW1Ob2RlLnkgKyBvZmZzZXQsIG5ld0luZm8ubmFtZSwgbmV3SW5mby51cmwgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIGlmIGF3YXkgZnJvbSBidWZmZXIgem9uZSBhbmQgbm90IHJlYWNoaW5nIGJvdHRvbSBvZiBjb250ZW50XG4gICAgICAgICAgICAgICAgaWYgKHZpZXdQb3MueSA+IGJ1ZmZlciAmJiBpdGVtTm9kZS55IC0gb2Zmc2V0ID4gLXRoaXMubm9kZS5oZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG5ld0lkeCA9IGl0ZW0uaW5kZXggKyBjdXJJdGVtQ291bnQ7XG4gICAgICAgICAgICAgICAgICAgIGxldCBuZXdJbmZvID0gdGhpcy5zY2VuZUxpc3RbbmV3SWR4XTtcbiAgICAgICAgICAgICAgICAgICAgaXRlbS51cGRhdGVJdGVtKG5ld0lkeCwgaXRlbU5vZGUueSAtIG9mZnNldCwgbmV3SW5mby5uYW1lLCBuZXdJbmZvLnVybCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIHVwZGF0ZSBsYXN0Q29udGVudFBvc1lcbiAgICAgICAgdGhpcy5sYXN0Q29udGVudFBvc1kgPSB0aGlzLm5vZGUueTtcbiAgICB9LFxufSk7XG4iXX0=