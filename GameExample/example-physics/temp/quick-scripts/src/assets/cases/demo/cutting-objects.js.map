{"version":3,"sources":["assets/cases/demo/cutting-objects.js"],"names":["EPSILON","POINT_SQR_EPSILON","compare","a","b","fraction","equals","epsilon","undefined","Math","abs","equalsVec2","x","y","pointInLine","point","cc","Intersection","pointLineDistance","Class","Component","onEnable","debugDrawFlags","director","getPhysicsManager","PhysicsManager","DrawBits","e_jointBit","e_shapeBit","onDisable","onLoad","canvas","find","on","Node","EventType","TOUCH_START","onTouchStart","TOUCH_END","onTouchEnd","TOUCH_MOVE","onTouchMove","ctx","getComponent","Graphics","event","touching","r1","r2","results","touchStartPoint","touchPoint","v2","touch","getLocation","recalcResults","sub","magSqr","forEach","r","pairs","i","result","j","length","pair","collider","splice","indexOf","push","sort","splitResults","split","maxPointsResult","splitResult","k","points","apply","body","node","position","getWorldPosition","rotation","getWorldRotation","parent","getScene","addComponent","RigidBody","newCollider","PhysicsPolygonCollider","p1","p2","getLocalPoint","newSplitResult1","newSplitResult2","index1","index2","pp1","pp2","indiceIndex1","indiceIndex2","indices","map","p","startPoint","clear","moveTo","lineTo","stroke","manager","rayCast","RayCastType","All","concat","circle","fill","update","dt"],"mappings":"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","sourceRoot":"/","sourcesContent":["// http://www.emanueleferonato.com/2011/08/05/slicing-splitting-and-cutting-objects-with-box2d-part-4-using-real-graphics/\n\nconst EPSILON = 0.1;\nconst POINT_SQR_EPSILON = 5;\n\nfunction compare(a, b) {\n    if (a.fraction > b.fraction) {\n        return 1;\n    } else if (a.fraction < b.fraction) {\n        return -1;\n\n    }\n    return 0;\n}\n\nfunction equals (a, b, epsilon) {\n    epsilon = epsilon === undefined ? EPSILON : epsilon;\n    return Math.abs(a-b) < epsilon;\n}\n\nfunction equalsVec2(a,b, epsilon) {\n    return equals(a.x, b.x, epsilon) && equals(a.y, b.y, epsilon);\n}\n\nfunction pointInLine (point, a, b) {\n    return cc.Intersection.pointLineDistance(point, a, b, true) < 1;\n}\n\ncc.Class({\n    extends: cc.Component,\n\n    onEnable: function () {\n        this.debugDrawFlags = cc.director.getPhysicsManager().debugDrawFlags;\n        cc.director.getPhysicsManager().debugDrawFlags = \n            cc.PhysicsManager.DrawBits.e_jointBit |\n            cc.PhysicsManager.DrawBits.e_shapeBit\n            ;\n    },\n\n    onDisable: function () {\n        cc.director.getPhysicsManager().debugDrawFlags = this.debugDrawFlags;\n    },\n\n    // use this for initialization\n    onLoad: function () {\n        var canvas = cc.find('Canvas');\n        canvas.on(cc.Node.EventType.TOUCH_START, this.onTouchStart, this);\n        canvas.on(cc.Node.EventType.TOUCH_END, this.onTouchEnd, this);\n        canvas.on(cc.Node.EventType.TOUCH_MOVE, this.onTouchMove, this);\n\n        this.ctx = this.getComponent(cc.Graphics);\n    },\n\n    onTouchStart: function (event) {\n        this.touching = true;\n        this.r1 = this.r2 = this.results = null;\n        this.touchStartPoint = this.touchPoint = cc.v2( event.touch.getLocation() );\n    },\n\n    onTouchMove: function (event) {\n        this.touchPoint = cc.v2( event.touch.getLocation() );\n    },\n\n    onTouchEnd: function (event) {\n        this.touchPoint = cc.v2( event.touch.getLocation() );\n        this.recalcResults();\n        this.touching = false;\n\n        let point = cc.v2( event.touch.getLocation() );\n        if ( equals(this.touchStartPoint.sub(point).magSqr(), 0) ) return;\n\n        // recalculate fraction, make fraction from one direction\n        this.r2.forEach(r => {\n            r.fraction = 1 - r.fraction;\n        });\n\n        let results = this.results;\n\n        let pairs = [];\n        \n        for (let i = 0; i < results.length; i++) {\n            let find = false;\n            let result = results[i];\n\n            for (let j = 0; j < pairs.length; j++) {\n                let pair = pairs[j];\n                if (pair[0] && result.collider === pair[0].collider) {\n                    find = true;\n\n                    // one collider may contains several fixtures, so raycast may through the inner fixture side\n                    // we need remove them from the result\n                    let r = pair.find((r) => {\n                        return r.point.sub(result.point).magSqr() <= POINT_SQR_EPSILON;\n                    });\n\n                    if (r) {\n                        pair.splice(pair.indexOf(r), 1);\n                    }\n                    else { \n                        pair.push(result);\n                    }\n\n                    break;\n                }\n            }\n\n            if (!find) {\n                pairs.push([result]);\n            }\n        }\n\n        for (let i = 0; i < pairs.length; i++) {\n            let pair = pairs[i];\n            if (pair.length < 2) {\n                continue;\n            }\n\n            // sort pair with fraction\n            pair = pair.sort(compare);\n\n            let splitResults = [];\n\n            // first calculate all results, not split collider right now\n            for (let j = 0; j < (pair.length - 1); j +=2) {\n                let r1 = pair[j];\n                let r2 = pair[j+1];\n\n                if (r1 && r2) {\n                    this.split(r1.collider, r1.point, r2.point, splitResults);\n                }\n            }\n\n            if (splitResults.length <= 0) {\n                continue;\n            }\n\n            let collider = pair[0].collider;\n\n            let maxPointsResult;\n            for (let j = 0; j < splitResults.length; j++) {\n                let splitResult = splitResults[j];\n\n                for (let k = 0; k < splitResult.length; k++) {\n                    if (typeof splitResult[k] === 'number') {\n                        splitResult[k] = collider.points[splitResult[k]];\n                    }\n                }\n\n                if (!maxPointsResult || splitResult.length > maxPointsResult.length) {\n                    maxPointsResult = splitResult;\n                }\n            }\n\n            if (maxPointsResult.length < 3) {\n                continue;\n            }\n\n            // keep max length points to origin collider\n            collider.points = maxPointsResult;\n            collider.apply();\n\n            let body = collider.body;\n\n            for (let j = 0; j < splitResults.length; j++) {\n                let splitResult = splitResults[j];\n\n                if (splitResult.length < 3) continue;\n                if (splitResult == maxPointsResult) continue;\n\n                // create new body\n                let node = new cc.Node();\n                node.position = body.getWorldPosition();\n                node.rotation = body.getWorldRotation();\n                node.parent = cc.director.getScene();\n                \n                node.addComponent(cc.RigidBody);\n                \n                let newCollider = node.addComponent(cc.PhysicsPolygonCollider);\n                newCollider.points = splitResult;\n                newCollider.apply();\n            }\n            \n        }\n    },\n\n    split: function (collider, p1, p2, splitResults) {\n        let body = collider.body;\n        let points = collider.points;\n\n\n        // The manager.rayCast() method returns points in world coordinates, so use the body.getLocalPoint() to convert them to local coordinates.\n        p1 = body.getLocalPoint(p1);\n        p2 = body.getLocalPoint(p2);\n\n\n        let newSplitResult1 = [p1, p2];\n        let newSplitResult2 = [p2, p1];\n\n        let index1, index2;\n        for (let i = 0; i < points.length; i++) {\n            let pp1 = points[i];\n            let pp2 = i === points.length - 1 ? points[0] : points[i+1];\n          \n            if (index1 === undefined && pointInLine(p1, pp1, pp2)) {\n                index1 = i;\n            }\n            else if (index2 === undefined && pointInLine(p2, pp1, pp2)) {\n                index2 = i;\n            }\n\n            if (index1 !== undefined && index2 !== undefined) {\n                break;\n            }\n        }\n\n        // console.log(index1 + ' : ' + index2);\n\n        if (index1 === undefined || index2 === undefined) {\n            debugger\n            return;\n        }\n\n        let splitResult, indiceIndex1 = index1, indiceIndex2 = index2;\n        if (splitResults.length > 0) {\n            for (let i = 0; i < splitResults.length; i++) {\n                let indices = splitResults[i];\n                indiceIndex1 = indices.indexOf(index1);\n                indiceIndex2 = indices.indexOf(index2);\n\n                if (indiceIndex1 !== -1 && indiceIndex2 !== -1) {\n                    splitResult = splitResults.splice(i, 1)[0];\n                    break;\n                }\n            }\n        }\n\n        if (!splitResult) {\n            splitResult = points.map((p, i) => {\n                return i;\n            });\n        }\n\n        for (let i = indiceIndex1 + 1; i !== (indiceIndex2+1); i++) {\n            if (i >= splitResult.length) {\n                i = 0;\n            }\n\n            let p = splitResult[i];\n            p = typeof p === 'number' ? points[p] : p;\n            \n            if (p.sub(p1).magSqr() < POINT_SQR_EPSILON || p.sub(p2).magSqr() < POINT_SQR_EPSILON) {\n                continue;\n            }\n\n            newSplitResult2.push(splitResult[i]);\n        }\n\n        for (let i = indiceIndex2 + 1; i !== indiceIndex1+1; i++) {\n            if (i >= splitResult.length) {\n                i = 0;\n            }\n\n            let p = splitResult[i];\n            p = typeof p === 'number' ? points[p] : p;\n            \n            if (p.sub(p1).magSqr() < POINT_SQR_EPSILON || p.sub(p2).magSqr() < POINT_SQR_EPSILON) {\n                continue;\n            }\n\n            newSplitResult1.push(splitResult[i]);\n        }\n\n        splitResults.push(newSplitResult1);\n        splitResults.push(newSplitResult2);\n    },\n\n    recalcResults: function () {\n        if (!this.touching) return;\n\n        let startPoint = this.touchStartPoint;\n        let point = this.touchPoint;\n\n        this.ctx.clear();\n        this.ctx.moveTo(this.touchStartPoint.x, this.touchStartPoint.y);\n        this.ctx.lineTo(point.x, point.y);\n        this.ctx.stroke();\n\n        let manager = cc.director.getPhysicsManager();\n\n        // manager.rayCast() method calls this function only when it sees that a given line gets into the body - it doesnt see when the line gets out of it.\n        // I must have 2 intersection points with a body so that it can be sliced, thats why I use manager.rayCast() again, but this time from B to A - that way the point, at which BA enters the body is the point at which AB leaves it!\n        let r1 = manager.rayCast(this.touchStartPoint, point, cc.RayCastType.All);\n        let r2 = manager.rayCast(point, this.touchStartPoint, cc.RayCastType.All);\n\n        let results = r1.concat(r2);\n\n        for (let i = 0; i < results.length; i++) {\n            let p = results[i].point;\n            this.ctx.circle(p.x, p.y, 5);\n        }  \n        this.ctx.fill();\n\n        this.r1 = r1;\n        this.r2 = r2;\n        this.results = results;\n    },\n\n    // called every frame, uncomment this function to activate update callback\n    update: function (dt) {\n        // body maybe moving, need calc raycast results in update\n        this.recalcResults();\n    },\n});\n"]}