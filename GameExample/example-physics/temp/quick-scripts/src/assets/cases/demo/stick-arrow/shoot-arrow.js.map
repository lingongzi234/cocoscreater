{"version":3,"sources":["assets/cases/demo/stick-arrow/shoot-arrow.js"],"names":["cc","Class","Component","properties","arrow","type","Node","onEnable","debugDrawFlags","director","getPhysicsManager","PhysicsManager","DrawBits","e_jointBit","e_shapeBit","onDisable","onLoad","node","on","EventType","TOUCH_START","onTouchBegan","arrowBodies","event","touchLoc","touch","getLocation","instantiate","active","vec","v2","sub","position","rotation","Math","atan2","y","x","PI","getScene","addChild","distance","mag","velocity","normalize","mulSelf","arrowBody","getComponent","RigidBody","linearVelocity","push","update","dt","dragConstant","i","length","speed","direction","pointingDirection","getWorldVector","flightDirection","flightSpeed","normalizeSelf","dot","dragForceMagnitude","abs","getMass","arrowTailPosition","getWorldPoint","applyForce","mul"],"mappings":"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","sourceRoot":"/","sourcesContent":["// http://www.iforce2d.net/b2dtut/sticky-projectiles\n// http://www.emanueleferonato.com/2012/12/14/box2d-flying-arrow-engine-first-attempt/\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        arrow: {\n            type: cc.Node,\n            default: null\n        }\n    },\n\n    onEnable: function () {\n        this.debugDrawFlags = cc.director.getPhysicsManager().debugDrawFlags;\n        cc.director.getPhysicsManager().debugDrawFlags = \n            cc.PhysicsManager.DrawBits.e_jointBit |\n            cc.PhysicsManager.DrawBits.e_shapeBit\n            ;\n    },\n\n    onDisable: function () {\n        cc.director.getPhysicsManager().debugDrawFlags = this.debugDrawFlags;\n    },\n\n    // use this for initialization\n    onLoad: function () {\n        this.node.on(cc.Node.EventType.TOUCH_START, this.onTouchBegan, this);\n        this.arrowBodies = [];\n    },\n\n    onTouchBegan: function (event) {\n        let touchLoc = event.touch.getLocation();\n\n        let node = cc.instantiate(this.arrow);\n        node.active = true;\n\n        let vec = cc.v2(touchLoc).sub(node.position);\n        node.rotation = -Math.atan2(vec.y, vec.x) * 180 / Math.PI;\n\n        cc.director.getScene().addChild(node);\n\n        let distance =  vec.mag();\n        let velocity =  vec.normalize().mulSelf(800);\n\n        let arrowBody = node.getComponent(cc.RigidBody);\n        arrowBody.linearVelocity = velocity;\n\n        this.arrowBodies.push(arrowBody);\n    },\n\n    // called every frame, uncomment this function to activate update callback\n    update: function (dt) {\n        let dragConstant = 0.1;\n        let arrowBodies = this.arrowBodies;\n        for (let i = 0; i < arrowBodies.length; i++) {\n            let arrowBody = arrowBodies[i];\n            let velocity = arrowBody.linearVelocity;\n            let speed = velocity.mag();\n            if (speed === 0) continue;\n            let direction = velocity.normalize();\n\n            let pointingDirection = arrowBody.getWorldVector( cc.v2( 1, 0 ) );\n            let flightDirection = arrowBody.linearVelocity;\n            let flightSpeed = flightDirection.mag();\n            flightDirection.normalizeSelf();\n            \n            let dot = flightDirection.dot(pointingDirection);\n            let dragForceMagnitude = (1 - Math.abs(dot)) * flightSpeed * flightSpeed * dragConstant * arrowBody.getMass();\n            \n            let arrowTailPosition = arrowBody.getWorldPoint( cc.v2( -80, 0 ) );\n            arrowBody.applyForce( flightDirection.mul(-dragForceMagnitude), arrowTailPosition, false );\n        }\n    },\n});\n"]}