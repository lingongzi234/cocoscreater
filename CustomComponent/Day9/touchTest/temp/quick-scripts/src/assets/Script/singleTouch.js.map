{"version":3,"sources":["assets/Script/singleTouch.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["const {ccclass, property} = cc._decorator;\n@ccclass\nexport default class Helloworld extends cc.Component {\n    /**\n     * 金币池节点\n     */\n    @property(cc.Node)\n    goldPool: cc.Node = null;\n\n    private _second: number = 0; // 长按计时器/秒数\n\n    private _max_second: number = 2; // 长按最大时间/秒数\n\n    /**\n     * 用于标记每个金币节点当前是否是被点击中\n     * 节点顺序与 goldPool.children 保持一致\n     */\n    private _goldClickedStates: boolean[] = [];\n\n    /**\n     * 新增：标记每个金币节点是否已经被“红色长按锁定”\n     * 节点顺序与 goldPool.children 保持一致\n     */\n    private _goldLockedStates: boolean[] = []; // 长按锁定状态数组\n\n    /**\n     * 缓存所有金币节点的包围盒及触摸标记数组，提升滑动性能\n     * 节点顺序与 goldPool.children 保持一致\n     */\n    private _goldWorldRects: cc.Rect[] = [];\n    private _sharedTouched: boolean[] = [];\n\n    timerCallback: Function = null; // 长按计时器回调函数\n\n    currentPressIdx: number = -1; // 当前正在计时长按的节点索引\n\n    onLoad () {\n\n        // 当前场景需要关闭多点触摸\n        // if (cc.macro.ENABLE_MULTI_TOUCH) {\n            cc.macro.ENABLE_MULTI_TOUCH = false;\n        // }\n        \n        const len = this.goldPool.childrenCount;\n        if (len === 0) return;\n\n        // 初始化点击状态和缓存数组\n        this._goldClickedStates = new Array(len).fill(false);\n        this._goldLockedStates = new Array(len).fill(false);\n        this._goldWorldRects = new Array(len);\n        this._sharedTouched = new Array(len).fill(false);\n    }\n\n    onEnable () {\n        const len = this.goldPool.childrenCount;\n        if (len === 0) return;\n        for (let i = 0; i < len; i++) {\n            const goldNode = this.goldPool.children[i];\n            // 获取当前节点世界包围盒并缓存到数组中\n            this._goldWorldRects[i] = goldNode.getBoundingBoxToWorld();\n            // 注册触摸事件监听\n            goldNode.on(cc.Node.EventType.TOUCH_START, this.onTouchGoldStart, this);\n            goldNode.on(cc.Node.EventType.TOUCH_MOVE, this.onTouchGoldMove, this);\n            goldNode.on(cc.Node.EventType.TOUCH_END, this.onTouchGoldEnd, this);\n            goldNode.on(cc.Node.EventType.TOUCH_CANCEL, this.onTouchGoldCancel, this);\n        }\n    }\n\n    onDisable () {\n        const len = this.goldPool.childrenCount;\n        if (len === 0) return;\n        // 节点世界包围盒数组清空，当需要时再重新计算保证正确性\n        this._goldWorldRects = [];\n        // 取消触摸事件监听\n        for (let i = 0; i < len; i++) {\n            const goldNode = this.goldPool.children[i];\n            this.offTouchEvent(goldNode);\n        }\n    }\n\n    onTouchGoldStart (event: cc.Event.EventTouch) {\n        // 找到节点索引\n        const goldNode = event.target as cc.Node;\n        const idx = goldNode.getSiblingIndex();\n\n        // 如果已经被长按锁定，则直接返回\n        if (this._goldLockedStates[idx]) return;\n        if (this.timerCallback === null) {\n            this.timerCallback = this.longPressTimerCallback.bind(this, goldNode, idx);\n        }\n        // 启动长按计时器，只记录当前按下的节点索引\n\n        this.currentPressIdx = idx;\n        this._second = 0;\n        this.schedule(this.timerCallback, 1, 1); // 1秒后触发一次，每次间隔1秒，共执行2次\n    }\n\n    longPressTimerCallback (target: cc.Node | null, idx: number) {\n        if (target === null || idx === -1) return;\n        this._second++;\n        console.log(\"长按计时器/秒数\", this._second);\n        if (this._second >= this._max_second) {\n            console.log(\"达到长按最大时间\");\n            this._second = 0;\n\n            // 标记节点为锁定，变为红色\n            target.color = cc.Color.RED;\n            this.offTouchEvent(target);\n            this._goldLockedStates[idx] = true;\n            this.currentPressIdx = -1;\n            this.cancelTimer();\n        }\n    }\n\n    /**\n     * 将重复的复位节点颜色逻辑进行封装\n     * 只重置非长按锁定（红色）的节点为白色\n     */\n    private resetAllGoldToWhiteExceptRed(touchLocation: cc.Vec2) {\n        const count = this.goldPool.childrenCount;\n        for (let i = 0; i < count; i++) {\n            let goldNode = this.goldPool.children[i];\n            // 跳过被红锁定的节点\n            if (this._goldLockedStates[i]) continue;\n            let rect = this._goldWorldRects[i];\n            let result = rect.contains(touchLocation);\n            if (result && goldNode.color !== cc.Color.WHITE) {\n                goldNode.color = cc.Color.WHITE;\n            }\n        }\n        this.cancelAndResetPressState();\n    }\n\n    /**\n     * 将释放计时器和复位长按状态逻辑合并，避免代码重复\n     */\n    private cancelAndResetPressState() {\n        this.cancelTimer();\n        this.currentPressIdx = -1;\n        this._second = 0;\n    }\n\n    /**\n     * 性能最优实现：\n     * 1. 只遍历一次每个触点，与节点做包围盒判断。\n     * 2. 只更新必要颜色和状态。\n     * 3. 复用 _sharedTouched 数组，避免每帧分配新数组。\n     * 4. 缓存包围盒处理，避免 getBoundingBoxToWorld 重复调用。\n     * 5. 被锁定为红色的节点不再处理变色\n     * 6. 长按时，如果手指移出原本的节点包围盒，立即取消计时器\n     */\n    onTouchGoldMove (event: cc.Event.EventTouch) {\n        const touches = event.getTouches();\n        const count = this.goldPool.childrenCount;\n        if (count === 0) return;\n\n        // 复用 _sharedTouched 数组\n        for (let i = 0; i < count; i++) this._sharedTouched[i] = false;\n\n        // 枚举所有触点（多指），利用缓存包围盒加速检测（忽略已锁定节点）\n        for (let t = 0; t < touches.length; t++) {\n            const loc = touches[t].getLocation();\n            for (let j = 0; j < count; j++) {\n                if (this._goldLockedStates[j]) continue; // 跳过被锁定节点\n                if (!this._sharedTouched[j] && this._goldWorldRects[j].contains(loc)) {\n                    this._sharedTouched[j] = true;\n                }\n            }\n        }\n\n        // 检查：如果有节点在计时长按，手指已移出其包围盒，则取消长按计时器\n        if (this.currentPressIdx !== -1) {\n            // 判断所有触点都不在当前计时节点上时，取消计时器\n            if (!this._sharedTouched[this.currentPressIdx]) {\n                this.cancelAndResetPressState();\n            }\n        }\n\n        // 只在状态变化时更新（忽略已锁定节点）\n        for (let i = 0; i < count; i++) {\n            if (this._goldLockedStates[i]) continue; // 已经锁定为红色，不再变色\n            const goldNode = this.goldPool.children[i];\n            if (this._sharedTouched[i]) {\n                if (!this._goldClickedStates[i]) {\n                    this._goldClickedStates[i] = true;\n                    goldNode.color = cc.Color.BLUE;\n                }\n            } else {\n                if (this._goldClickedStates[i]) {\n                    this._goldClickedStates[i] = false;\n                    goldNode.color = cc.Color.WHITE;\n                }\n            }\n        }\n    }\n\n    onTouchGoldEnd (event: cc.Event.EventTouch) {\n        this.resetAllGoldToWhiteExceptRed(event.getLocation());\n    }\n\n    onTouchGoldCancel (event: cc.Event.EventTouch) {\n        this.resetAllGoldToWhiteExceptRed(event.getLocation());\n    }\n\n    offTouchEvent (target: cc.Node) {\n        target.off(cc.Node.EventType.TOUCH_START, this.onTouchGoldStart, this);\n        target.off(cc.Node.EventType.TOUCH_MOVE, this.onTouchGoldMove, this);\n        target.off(cc.Node.EventType.TOUCH_END, this.onTouchGoldEnd, this);\n        target.off(cc.Node.EventType.TOUCH_CANCEL, this.onTouchGoldCancel, this);\n    }\n\n    cancelTimer () {\n        // 检查timerCallback避免无效反注册\n        if (this.timerCallback) {\n            this.unschedule(this.timerCallback);\n            this.timerCallback = null;\n        }\n    }\n}\n"]}